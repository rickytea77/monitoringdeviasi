import React, { useState, useEffect } from 'react';
import { Plus, AlertTriangle, Calendar, TrendingUp, X, BarChart3, Download, Upload } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

const MenuMonitoringSystem = () => {
  const [menuRecords, setMenuRecords] = useState([]);
  const [showForm, setShowForm] = useState(false);
  const [dbReady, setDbReady] = useState(false);
  const [formData, setFormData] = useState({
    tanggal: '',
    mealTime: 'breakfast',
    menuUtamaRencana: '',
    menuUtamaDisajikan: '',
    menuPendampingRencana: '',
    menuPendampingDisajikan: '',
    sayuranRencana: '',
    sayuranDisajikan: '',
    jumlahPorsi: '',
    alasanDeviasi: '',
    kategoriDeviasi: 'substitusi'
  });
  const [filter, setFilter] = useState('semua');
  const [dateRange, setDateRange] = useState('7hari');

  // IndexedDB setup
  const DB_NAME = 'CateringMenuDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'menuRecords';

  const initDB = () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          objectStore.createIndex('tanggal', 'tanggal', { unique: false });
          objectStore.createIndex('mealTime', 'mealTime', { unique: false });
        }
      };
    });
  };

  const getAllRecords = async () => {
    try {
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const objectStore = transaction.objectStore(STORE_NAME);
      const request = objectStore.getAll();

      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    } catch (error) {
      console.error('Error getting records:', error);
      return [];
    }
  };

  const addRecord = async (record) => {
    try {
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const objectStore = transaction.objectStore(STORE_NAME);
      const request = objectStore.add(record);

      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    } catch (error) {
      console.error('Error adding record:', error);
      throw error;
    }
  };

  const deleteRecord = async (id) => {
    try {
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const objectStore = transaction.objectStore(STORE_NAME);
      const request = objectStore.delete(id);

      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    } catch (error) {
      console.error('Error deleting record:', error);
      throw error;
    }
  };

  const loadData = async () => {
    const records = await getAllRecords();
    setMenuRecords(records.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)));
  };

  useEffect(() => {
    const initializeDB = async () => {
      try {
        await initDB();
        setDbReady(true);
        await loadData();
      } catch (error) {
        console.error('Failed to initialize DB:', error);
      }
    };
    initializeDB();
  }, []);

  const checkDeviasi = (data) => {
    const deviasi = {
      menuUtama: data.menuUtamaRencana.toLowerCase().trim() !== data.menuUtamaDisajikan.toLowerCase().trim(),
      menuPendamping: data.menuPendampingRencana.toLowerCase().trim() !== data.menuPendampingDisajikan.toLowerCase().trim(),
      sayuran: data.sayuranRencana.toLowerCase().trim() !== data.sayuranDisajikan.toLowerCase().trim()
    };
    
    const hasDeviasi = deviasi.menuUtama || deviasi.menuPendamping || deviasi.sayuran;
    
    return { hasDeviasi, deviasi };
  };

  const handleSubmit = async () => {
    const deviasiCheck = checkDeviasi(formData);
    
    if (!deviasiCheck.hasDeviasi) {
      alert('Menu sesuai rencana, tidak perlu dicatat');
      return;
    }

    const newRecord = {
      ...formData,
      id: Date.now(),
      ...deviasiCheck,
      timestamp: new Date().toISOString()
    };

    try {
      await addRecord(newRecord);
      await loadData();
      setShowForm(false);
      setFormData({
        tanggal: '',
        mealTime: 'breakfast',
        menuUtamaRencana: '',
        menuUtamaDisajikan: '',
        menuPendampingRencana: '',
        menuPendampingDisajikan: '',
        sayuranRencana: '',
        sayuranDisajikan: '',
        jumlahPorsi: '',
        alasanDeviasi: '',
        kategoriDeviasi: 'substitusi'
      });
    } catch (error) {
      alert('Gagal menyimpan data');
    }
  };

  const handleDelete = async (id) => {
    if (confirm('Hapus record ini?')) {
      try {
        await deleteRecord(id);
        await loadData();
      } catch (error) {
        alert('Gagal menghapus data');
      }
    }
  };

  const exportData = () => {
    const dataStr = JSON.stringify(menuRecords, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `catering-menu-deviasi-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const importData = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      if (!Array.isArray(data)) {
        alert('Format file tidak valid');
        return;
      }

      for (const record of data) {
        await addRecord(record);
      }
      
      await loadData();
      alert(`Berhasil mengimport ${data.length} record`);
    } catch (error) {
      alert('Gagal mengimport data: ' + error.message);
    }
    event.target.value = '';
  };

  const getFilteredRecords = () => {
    let filtered = [...menuRecords];
    
    const now = new Date();
    const daysAgo = dateRange === '7hari' ? 7 : dateRange === '30hari' ? 30 : 365;
    const cutoffDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
    
    filtered = filtered.filter(r => new Date(r.tanggal) >= cutoffDate);

    if (filter === 'menuUtama') {
      filtered = filtered.filter(r => r.deviasi && r.deviasi.menuUtama);
    } else if (filter === 'menuPendamping') {
      filtered = filtered.filter(r => r.deviasi && r.deviasi.menuPendamping);
    } else if (filter === 'sayuran') {
      filtered = filtered.filter(r => r.deviasi && r.deviasi.sayuran);
    }

    return filtered;
  };

  const calculateStats = () => {
    const allRecords = [...menuRecords];
    const now = new Date();
    const daysAgo = dateRange === '7hari' ? 7 : dateRange === '30hari' ? 30 : 365;
    const cutoffDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
    const filtered = allRecords.filter(r => new Date(r.tanggal) >= cutoffDate);
    
    const total = filtered.length;
    
    const deviasiMenuUtama = filtered.filter(r => r.deviasi && r.deviasi.menuUtama).length;
    const deviasiMenuPendamping = filtered.filter(r => r.deviasi && r.deviasi.menuPendamping).length;
    const deviasiSayuran = filtered.filter(r => r.deviasi && r.deviasi.sayuran).length;

    const kategoriCount = {};
    filtered.forEach(r => {
      kategoriCount[r.kategoriDeviasi] = (kategoriCount[r.kategoriDeviasi] || 0) + 1;
    });

    return { 
      total, 
      deviasiMenuUtama, 
      deviasiMenuPendamping, 
      deviasiSayuran,
      kategoriCount 
    };
  };

  const getChartData = () => {
    const stats = calculateStats();
    
    const barData = [
      { name: 'Menu Utama', jumlah: stats.deviasiMenuUtama, fill: '#ef4444' },
      { name: 'Menu Pendamping', jumlah: stats.deviasiMenuPendamping, fill: '#a855f7' },
      { name: 'Sayuran', jumlah: stats.deviasiSayuran, fill: '#22c55e' }
    ];

    const pieData = Object.entries(stats.kategoriCount).map(([name, value]) => ({
      name: name.charAt(0).toUpperCase() + name.slice(1),
      value
    }));

    return { barData, pieData };
  };

  const stats = calculateStats();
  const filteredRecords = getFilteredRecords();
  const chartData = getChartData();

  const COLORS = ['#f97316', '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];

  const getMealTimeLabel = (mealTime) => {
    const labels = {
      breakfast: 'Breakfast',
      lunch: 'Lunch',
      dinner: 'Dinner',
      supper: 'Supper'
    };
    return labels[mealTime] || mealTime;
  };

  if (!dbReady) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto"></div>
          <p className="mt-4 text-gray-600">Memuat database...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <Calendar className="text-orange-500" />
                Monitoring Deviasi Menu Catering
              </h1>
              <p className="text-gray-600 mt-1">Catat deviasi menu utama, menu pendamping, dan sayuran • Database: IndexedDB</p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={exportData}
                className="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg flex items-center gap-2 transition shadow-md"
                title="Export Data"
              >
                <Download size={20} />
              </button>
              <label className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg flex items-center gap-2 transition shadow-md cursor-pointer" title="Import Data">
                <Upload size={20} />
                <input type="file" accept=".json" onChange={importData} className="hidden" />
              </label>
              <button
                onClick={() => setShowForm(!showForm)}
                className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-md"
              >
                <Plus size={20} />
                Catat Deviasi
              </button>
            </div>
          </div>

          {/* Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
              <div className="text-blue-600 text-sm font-semibold">Total Deviasi</div>
              <div className="text-3xl font-bold text-blue-700 mt-1">{stats.total}</div>
              <div className="text-xs text-blue-500 mt-1">Total: {menuRecords.length} record</div>
            </div>
            <div className="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
              <div className="text-red-600 text-sm font-semibold">Menu Utama</div>
              <div className="text-3xl font-bold text-red-700 mt-1">{stats.deviasiMenuUtama}</div>
            </div>
            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
              <div className="text-purple-600 text-sm font-semibold">Menu Pendamping</div>
              <div className="text-3xl font-bold text-purple-700 mt-1">{stats.deviasiMenuPendamping}</div>
            </div>
            <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
              <div className="text-green-600 text-sm font-semibold">Sayuran</div>
              <div className="text-3xl font-bold text-green-700 mt-1">{stats.deviasiSayuran}</div>
            </div>
          </div>
        </div>

        {/* Charts */}
        {stats.total > 0 && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            {/* Bar Chart */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <BarChart3 className="text-orange-500" />
                Deviasi per Jenis Menu
              </h3>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={chartData.barData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="jumlah" fill="#f97316" radius={[8, 8, 0, 0]}>
                    {chartData.barData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.fill} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Pie Chart */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <TrendingUp className="text-orange-500" />
                Kategori Deviasi
              </h3>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={chartData.pieData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {chartData.pieData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>
        )}

        {/* Form Input */}
        {showForm && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">Input Data Deviasi Menu</h2>
              <button onClick={() => setShowForm(false)} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Tanggal</label>
                  <input
                    type="date"
                    value={formData.tanggal}
                    onChange={(e) => setFormData({...formData, tanggal: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Waktu Makan</label>
                  <select
                    value={formData.mealTime}
                    onChange={(e) => setFormData({...formData, mealTime: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                  >
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="supper">Supper</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Jumlah Porsi</label>
                  <input
                    type="number"
                    value={formData.jumlahPorsi}
                    onChange={(e) => setFormData({...formData, jumlahPorsi: e.target.value})}
                    placeholder="100"
                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                    required
                  />
                </div>
              </div>

              {/* Menu Utama */}
              <div className="border-t pt-4">
                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <span className="bg-red-500 text-white px-2 py-1 rounded text-sm">1</span>
                  Menu Utama
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Rencana</label>
                    <input
                      type="text"
                      value={formData.menuUtamaRencana}
                      onChange={(e) => setFormData({...formData, menuUtamaRencana: e.target.value})}
                      placeholder="Contoh: Ayam Goreng"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Disajikan</label>
                    <input
                      type="text"
                      value={formData.menuUtamaDisajikan}
                      onChange={(e) => setFormData({...formData, menuUtamaDisajikan: e.target.value})}
                      placeholder="Contoh: Ayam Bakar"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Menu Pendamping */}
              <div className="border-t pt-4">
                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <span className="bg-purple-500 text-white px-2 py-1 rounded text-sm">2</span>
                  Menu Pendamping
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Rencana</label>
                    <input
                      type="text"
                      value={formData.menuPendampingRencana}
                      onChange={(e) => setFormData({...formData, menuPendampingRencana: e.target.value})}
                      placeholder="Contoh: Nasi Goreng"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Disajikan</label>
                    <input
                      type="text"
                      value={formData.menuPendampingDisajikan}
                      onChange={(e) => setFormData({...formData, menuPendampingDisajikan: e.target.value})}
                      placeholder="Contoh: Nasi Putih"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Sayuran */}
              <div className="border-t pt-4">
                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <span className="bg-green-500 text-white px-2 py-1 rounded text-sm">3</span>
                  Sayuran
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Rencana</label>
                    <input
                      type="text"
                      value={formData.sayuranRencana}
                      onChange={(e) => setFormData({...formData, sayuranRencana: e.target.value})}
                      placeholder="Contoh: Capcay"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Disajikan</label>
                    <input
                      type="text"
                      value={formData.sayuranDisajikan}
                      onChange={(e) => setFormData({...formData, sayuranDisajikan: e.target.value})}
                      placeholder="Contoh: Tumis Kangkung"
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Kategori dan Alasan */}
              <div className="border-t pt-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">Kategori Deviasi</label>
                    <select
                      value={formData.kategoriDeviasi}
                      onChange={(e) => setFormData({...formData, kategoriDeviasi: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                    >
                      <option value="substitusi">Substitusi Bahan</option>
                      <option value="stok">Kehabisan Stok</option>
                      <option value="kualitas">Masalah Kualitas</option>
                      <option value="permintaan">Permintaan Khusus</option>
                      <option value="supplier">Masalah Supplier</option>
                      <option value="lainnya">Lainnya</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Alasan Deviasi</label>
                  <textarea
                    value={formData.alasanDeviasi}
                    onChange={(e) => setFormData({...formData, alasanDeviasi: e.target.value})}
                    placeholder="Jelaskan alasan terjadinya deviasi..."
                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 h-20"
                    required
                  />
                </div>
              </div>

              <div className="flex gap-3 border-t pt-4">
                <button
                  onClick={handleSubmit}
                  className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg transition font-semibold"
                >
                  Simpan Deviasi
                </button>
                <button
                  onClick={() => setShowForm(false)}
                  className="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg transition font-semibold"
                >
                  Batal
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Filters */}
        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
          <div className="flex flex-wrap gap-4 items-center">
            <div>
              <label className="text-sm font-semibold text-gray-700 mr-2">Filter Jenis:</label>
              <select
                value={filter}
                onChange={(e) => setFilter(e.target.value)}
                className="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              >
                <option value="semua">Semua Deviasi</option>
                <option value="menuUtama">Menu Utama Saja</option>
                <option value="menuPendamping">Menu Pendamping Saja</option>
                <option value="sayuran">Sayuran Saja</option>
              </select>
            </div>
            <div>
              <label className="text-sm font-semibold text-gray-700 mr-2">Periode:</label>
              <select
                value={dateRange}
                onChange={(e) => setDateRange(e.target.value)}
                className="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
              >
                <option value="7hari">7 Hari Terakhir</option>
                <option value="30hari">30 Hari Terakhir</option>
                <option value="semua">Semua Data</option>
              </select>
            </div>
          </div>
        </div>

        {/* Records Table */}
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-orange-500 text-white">
                <tr>
                  <th className="p-3 text-left">Tanggal</th>
                  <th className="p-3 text-left">Waktu Makan</th>
                  <th className="p-3 text-center">Porsi</th>
                  <th className="p-3 text-left">Jenis Deviasi</th>
                  <th className="p-3 text-left">Detail Menu</th>
                  <th className="p-3 text-left">Kategori</th>
                  <th className="p-3 text-left">Alasan</th>
                  <th className="p-3 text-center">Aksi</th>
                </tr>
              </thead>
              <tbody>
                {filteredRecords.length === 0 ? (
                  <tr>
                    <td colSpan="8" className="p-8 text-center text-gray-500">
                      {filter !== 'semua' ? 'Tidak ada data untuk filter yang dipilih' : 'Belum ada data deviasi. Klik "Catat Deviasi" untuk menambahkan!'}
                    </td>
                  </tr>
                ) : (
                  filteredRecords.map((record) => (
                    <tr key={record.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">{new Date(record.tanggal).toLocaleDateString('id-ID')}</td>
                      <td className="p-3">{getMealTimeLabel(record.mealTime)}</td>
                      <td className="p-3 text-center">{record.jumlahPorsi}</td>
                      <td className="p-3">
                        <div className="flex flex-wrap gap-1">
                          {record.deviasi.menuUtama && (
                            <span className="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-semibold">
                              Menu Utama
                            </span>
                          )}
                          {record.deviasi.menuPendamping && (
                            <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-semibold">
                              Pendamping
                            </span>
                          )}
                          {record.deviasi.sayuran && (
                            <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold">
                              Sayuran
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="p-3 text-sm">
                        {record.deviasi.menuUtama && (
                          <div className="mb-1">
                            <span className="font-semibold text-red-600">Utama:</span> {record.menuUtamaRencana} → {record.menuUtamaDisajikan}
                          </div>
                        )}
                        {record.deviasi.menuPendamping && (
                          <div className="mb-1">
                            <span className="font-semibold text-purple-600">Pendamping:</span> {record.menuPendampingRencana} → {record.menuPendampingDisajikan}
                          </div>
                        )}
                        {record.deviasi.sayuran && (
                          <div>
                            <span className="font-semibold text-green-600">Sayuran:</span> {record.sayuranRencana} → {record.sayuranDisajikan}
                          </div>
                        )}
                      </td>
                      <td className="p-3 capitalize text-sm">{record.kategoriDeviasi}</td>
                      <td className="p-3 text-sm">{record.alasanDeviasi}</td>
                      <td className="p-3 text-center">
                        <button
                          onClick={() => handleDelete(record.id)}
                          className="text-red-600 hover:text-red-800 font-semibold text-sm"
                        >
                          Hapus
                        </button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Deviasi Details */}
        {stats.total > 0 && (
          <div className="bg-white rounded-xl shadow-lg p-6 mt-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Rincian Kategori Deviasi</h3>
            <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
              {Object.entries(stats.kategoriCount).map(([kategori, count]) => (
                <div key={kategori} className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                  <div className="text-sm text-gray-600 capitalize">{kategori}</div>
                  <div className="text-2xl font-bold text-gray-800">{count}</div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MenuMonitoringSystem;